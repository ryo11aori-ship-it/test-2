name: Test autobuildtool (build+run C & Python)

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - 'sample/**'
      - 'autobuildtool.exe'
      - '.github/workflows/test-build-and-run.yml'

jobs:
  build-and-run:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: List repo root (debug)
        shell: cmd
        run: dir

      # Install Zig via Chocolatey and export path for AUTOBUILD_ZIG
      - name: Install Zig and expose path
        shell: powershell
        run: |
          choco install zig -y
          $zig = (Get-Command zig -ErrorAction Stop).Source
          Write-Host "Found zig at: $zig"
          echo "AUTOBUILD_ZIG=$zig" >> $env:GITHUB_ENV

      # Install PyInstaller (for Python builds)
      - name: Install PyInstaller (for Python builds)
        shell: powershell
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller

      - name: Ensure autobuildtool.exe exists
        shell: cmd
        run: |
          if not exist autobuildtool.exe (
            echo ERROR: autobuildtool.exe not found at repo root
            exit 1
          )
          echo autobuildtool.exe found

      - name: Set code page to UTF-8 (recommended)
        shell: cmd
        run: chcp 65001

      ################################################################
      # Build sample/main.c using autobuildtool.exe
      ################################################################
      - name: Build sample/main.c with autobuildtool (non-interactive)
        shell: cmd
        run: |
          .\autobuildtool.exe sample\main.c sample_c.exe

      - name: Verify sample C exe exists
        shell: cmd
        run: |
          if exist sample_c.exe (
            echo "Built sample_c.exe found"
            dir sample_c.exe
          ) else (
            echo Build failed: sample_c.exe not found & exit /b 2
          )

      - name: Run sample_c.exe and capture stdout
        shell: cmd
        run: |
          echo Running sample_c.exe...
          sample_c.exe > run_output_c.txt 2>&1
          type run_output_c.txt

      ################################################################
      # Build sample/main.py using autobuildtool.exe
      ################################################################
      - name: Build sample/main.py with autobuildtool (non-interactive)
        shell: cmd
        run: |
          .\autobuildtool.exe sample\main.py sample_py.exe

      - name: Debug dist folder for python exe (if present)
        shell: cmd
        run: |
          if exist dist (
            echo ---- dist folder contents ----
            dir dist
            if exist dist\sample_py (
              echo ---- dist\sample_py contents ----
              dir dist\sample_py
            )
          ) else (
            echo dist folder not present
          )

      - name: Ensure python exe is accessible (copy from dist if needed)
        shell: cmd
        run: |
          if exist dist\sample_py\sample_py.exe (
            echo Found dist\sample_py\sample_py.exe - copying to repo root
            copy /Y dist\sample_py\sample_py.exe sample_py.exe
          ) else if exist dist\sample_py.exe (
            echo Found dist\sample_py.exe - copying to repo root
            copy /Y dist\sample_py.exe sample_py.exe
          ) else (
            if exist sample_py.exe (
              echo sample_py.exe already in repo root
            ) else (
              echo Build failed: sample_py.exe not found & exit /b 3
            )
          )

      - name: Run sample_py.exe (CI short mode) and capture stdout
        shell: powershell
        run: |
          Write-Host "Running sample_py.exe with --ci-test..."
          $exe = Join-Path $PWD "sample_py.exe"
          $out = Join-Path $PWD "run_output_py.txt"
          $err = Join-Path $PWD "run_error_py.txt"

          $ps = Start-Process -FilePath $exe -ArgumentList "--ci-test" -RedirectStandardOutput $out -RedirectStandardError $err -PassThru
          # wait up to 30s for quick CI test
          $finished = $ps.WaitForExit(30000)
          if (-not $finished) {
            Write-Host "Process did not exit within 30s; killing (CI mode expects short run)..."
            try { $ps.Kill() } catch { Write-Host "Failed to kill process: $_" }
          }

          Write-Host "---- PY STDOUT ----"
          if (Test-Path $out) { Get-Content $out -Raw } else { Write-Host "(no stdout file)" }

          Write-Host "---- PY STDERR ----"
          if (Test-Path $err) { Get-Content $err -Raw } else { Write-Host "(no stderr file)" }

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: test-artifacts
          if-no-files-found: warn
          path: |
            sample_c.exe
            run_output_c.txt
            sample_py.exe
            run_output_py.txt
            run_error_py.txt
            sample_c_artifact.txt
            sample_py_artifact.txt
